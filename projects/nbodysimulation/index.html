<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> N-Body Simulation | Yuanqi Wang </title> <meta name="author" content="Yuanqi Wang"> <meta name="description" content="N-Body Simulation in Java, using Barnes–Hut Simulation"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A8%F0%9F%8F%BB%E2%80%8D%F0%9F%92%BB&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://www.yqwong.com/projects/nbodysimulation/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Yuanqi</span> Wang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">N-Body Simulation</h1> <p class="post-description">N-Body Simulation in Java, using Barnes–Hut Simulation</p> </header> <article> <p><a href="https://github.com/plasmas/NBodySim" rel="external nofollow noopener" target="_blank">Source</a></p> <p><em>Per course policy, access to code is only granted upon request.</em></p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <iframe src="https://www.youtube-nocookie.com/embed/khf67kJt4hQ" class="img-fluid rounded z-depth-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" width="auto" height="auto"></iframe> </figure> </div> </div> <h2 id="result-showcase">Result Showcase</h2> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/nbodysimulation/circular-480.webp 480w,/assets/img/projects/nbodysimulation/circular-800.webp 800w,/assets/img/projects/nbodysimulation/circular-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/projects/nbodysimulation/circular.gif" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Planetary Simulation of 2 bodies" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/projects/nbodysimulation/multiple-480.webp 480w,/assets/img/projects/nbodysimulation/multiple-800.webp 800w,/assets/img/projects/nbodysimulation/multiple-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/projects/nbodysimulation/multiple.gif" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Simulation of 100 particles of same mass" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Left: Simulating circular motion; Right: Simulating 100 particles. </div> <hr> <h2 id="the-problem">The Problem</h2> <p>In this project, we aim to provide an efficient method to simulate the N-Body problem widely explored in physics and astronomy. The N-Body simulation is defined by Wikipedia as follows:</p> <blockquote> <p>An N-body simulation is a simulation of a dynamical system of particles, usually under the influence of physical forces, such as gravity.</p> </blockquote> <p>We plan to model the movement of a vast number of particles with initial positions, speed, and mass. We mainly model two phenomena: (a) the effect of gravity among particles, and (b) the effect of collision between two particles.</p> <h3 id="gravity">Gravity</h3> <p>We assume that gravity exists between any two particles with mass. We calculate gravity based on the formula given by Newton:</p> \[F=G \frac{m_1m_2}{r^2}\] <p>where \(G\) is the gravitational constant, \(m_1,m_2\) are the mass of the two objects experiencing gravitational force, and \(r\) is the distance between the pair.</p> <p>Based on the gravity between a pair of particles, we can calculate the acceleration exerted by this force on the two particles, and thus the speed of the particles in the next iteration.</p> <h3 id="collision">Collision</h3> <p>As particles fly through space, there is a chance that two particles may hit each other head-on. We assume that each particle has no volume, so every collision will always be head-on. We also assume that the collision is completely elastic, so no kinetic energy is lost in this process. With these two assumptions, we can calculate the speed after the collision through preservation of momentum and kinetic energy. We can use the following formula to calculate speed of the objects after collision:</p> \[\textbf{v}_1' = \textbf{v}_1 - \frac{2m_2}{m_1 + m_2} \frac{(\textbf{v}_1 - \textbf{v}_2) \cdot (\textbf{x}_1 - \textbf{x}_2)}{|\textbf{x}_1 - \textbf{x}_2|^2} (\textbf{x}_1 - \textbf{x}_2)\] \[\textbf{v}_2' = \textbf{v}_2 - \frac{2m_1}{m_1 + m_2} \frac{(\textbf{v}_2 - \textbf{v}_1) \cdot (\textbf{x}_2 - \textbf{x}_1)}{|\textbf{x}_2 - \textbf{x}_1|^2} (\textbf{x}_2 - \textbf{x}_1)\] <p>where \(\textbf{v}_1,\textbf{v}_2\) are the initial speed vectors of the two particles, \(\textbf{v}_1',\textbf{v}_2'\) are the resulting speed vectors after the collision, and \(\textbf{x}_1,\textbf{x}_2\) are the position vectors.</p> <hr> <h2 id="the-naive-approach">The Naive Approach</h2> <p>The naive approach for gravity calculation and collision detection will take \(O(n^2)\) time each, where \(n\) is the number of particles in the simulation box.</p> <ul> <li>To calculate the gravity force exerted on each particle, we will need to calculate the gravity exerted by the other \(n-1\) particles. Thus, calculating the gravity force for each particle takes \(O(n)\) time, and the calculation for the whole system takes \(O(n^2)\) time.</li> <li>To check whether one particle has collided with another particle, we will need to calculate the distance between the particles, and if the distance is closer than some predefined cutoff value, we treat the two particles as if they have collided. We need to check whether collision happen between any two pairs of particles, and since there are \(O(n^2)\) pairs, checking would also take \(O(n^2)\) time.</li> </ul> <p>Since we want to simulate the movement of a huge number of particles, we would want our algorithm for simulation to be as efficient as possible. We try to push the efficiency beyond \(O(n^2)\) through taking advantage of the data structure called <strong>quad tree</strong>.</p> <hr> <h2 id="our-implementation-through-quad-tree">Our Implementation through Quad Tree</h2> <p>We choose to use a quad tree to speed up our calculation for gravity and collision detection. This improves the run time of our algorithm to \(O(n \log n)\). A quad tree is a recursive data structure used to store spatial information. Each node in the quad tree represents a quadrant of a given region, and the four children of the node represent the sub-quadrants if we divide up the quadrant along the vertical and horizontal axes.</p> <h3 id="approximating-gravity">Approximating Gravity</h3> <p>This data structure can help us approximate the gravity force very efficiently. We approximate the gravity force exerted on a given particle by merging particles that are far away from our given particle to a single particle, called centroid, residing at the center of mass of the particles. Through this approximation, we no longer need to do pairwise calculation between particles that are far away from each other. Instead, we calculate the force exerted on one particle from a cluster of particles together.</p> <div align="center"> <img src="/assets/img/projects/nbodysimulation/findingCoM.gif" style="width: 100%; height: auto;"> <p>Credit: <a href="https://jheer.github.io/barnes-hut/" rel="external nofollow noopener" target="_blank">The Barnes-Hut Approximation</a></p> </div> <p>The specific implementation for this method is to recursively build up centroids at each level when we traverse the quad tree in post-order. But one thing that we should note is that this approximation does not work when the particles are too close to each other. Therefore, we define a parameter \(\theta\) to be the cutoff point, and if the ratio of the length of the side of the quadrant to the distance between the two particles is greater than this value, i.e. the two particles are too close, we will use pairwise calculation instead of this approximation. Because the maximum depth we will reach is the height of the quad tree, this method yields \(O(\log n)\) time for calculating the gravity for each particle, and cumulatively \(O(n \log n)\) time.</p> <h3 id="detecting-collision">Detecting Collision</h3> <p>To detect collision, we first define a collision distance, and if the distance between two particles is less than the collision distance, we consider that the particles have collided. Next, we define the minimum length of the quadrant in the quad tree to be at least the length of the collision distance. In this way, we will also have a maximum height of the quad tree.</p> <p>In our implementation, two particles have collided if they share the same quadrant and that quadrant can no longer be subdivided (i.e. we have reached the maximum height). Then it is easy to check if a particle is involved in some collision: we simply find the particle in the quad tree, and check, first, if the quadrant the particle is in a minimum quadrant, and second, if any other particle also exists in the quadrant. This only takes \(O(\log n)\) time because the search path in the quad tree is at most the height of the tree.</p> <p>In the edge case where multiple particles exist in the same minimum quadrant, we treat the collision sequentially. In the case where there are three particles, the two particles that are closest collide first, then the particle that is closest to the third collides with the third.</p> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Yuanqi Wang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 30, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>